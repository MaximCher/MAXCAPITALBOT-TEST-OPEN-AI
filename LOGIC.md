# Логика работы MAXCAPITAL Bot

## Общая концепция

Бот для инвесторов по базовым продуктам MAXCAPITAL.CH с интеграцией Bitrix24 и Google Drive.

## Структура базы знаний в Google Drive

### 1. Папка "Materials" (DRIVE_MATERIALS_FOLDER_ID)
**Назначение:** Документы для отправки клиентам

**Содержимое:**
- Презентации проектов
- Брошюры продуктов
- Инвестиционные предложения
- Договоры и соглашения
- Сертификаты

**Логика поиска:**
- По intent автоматически подбираются релевантные материалы
- При intent="invest" → ищутся файлы с ключевыми словами: инвестиц*, продукт*, проект*
- При intent="documents" → ищутся файлы: документ*, презентация*, брошюра*
- При intent="consult" → ищутся файлы: консультация*, информация*, руководство*
- При intent="support" → ищутся файлы: поддержка*, помощь*, FAQ*

### 2. Папка "Info" (DRIVE_INFO_FOLDER_ID)
**Назначение:** Информация для общения с клиентом

**Содержимое:**
- Скрипты ответов бота
- FAQ (часто задаваемые вопросы)
- Описания продуктов
- Инструкции для менеджеров

**Логика использования:**
- Используется для получения контекстной информации
- Помогает боту давать более точные ответы
- Может содержать шаблоны сообщений

## Процесс работы бота

### 1. Пользователь начинает общение
- Команда `/start` или первое сообщение
- Создается сессия в статистике
- Записывается: user_id, username, timestamp

### 2. Обработка сообщения
```
Пользователь → Бот → Intent Detection → Bitrix24 → Google Drive → Ответ
```

**Шаги:**
1. Получение сообщения от пользователя
2. Определение намерения (intent detection)
3. Создание/обновление контакта в Bitrix24
4. Создание лида в Bitrix24 с назначением менеджера
5. Поиск материалов в базе знаний (Google Drive)
6. Формирование и отправка ответа пользователю

### 3. Назначение менеджера в Bitrix24

**Логика назначения:**
- По intent: `B24_MANAGER_INVEST`, `B24_MANAGER_DOCUMENTS`, и т.д.
- По умолчанию: `B24_DEFAULT_MANAGER_ID`
- Можно настроить разных менеджеров для разных типов запросов

**Пример:**
```
B24_MANAGER_INVEST=123  # Менеджер для инвестиций
B24_MANAGER_DOCUMENTS=456  # Менеджер для документов
B24_DEFAULT_MANAGER_ID=789  # Менеджер по умолчанию
```

### 4. Интеграция с Bitrix24

**Что создается:**
- **Контакт** (Contact): информация о пользователе
- **Лид** (Lead): потенциальная сделка с назначенным менеджером
- **Источник:** "MAXCAPITAL Telegram Bot"

**Поля лида:**
- NAME, PHONE, EMAIL
- COMMENTS (текст сообщения)
- ASSIGNED_BY_ID (ответственный менеджер)
- SOURCE_ID: "WEB"
- SOURCE_DESCRIPTION: "MAXCAPITAL Telegram Bot"

## Статистика и аналитика

### Отслеживаемые метрики

1. **Стартовые сессии**
   - Сколько пользователей начали общение
   - По датам

2. **Конверсия в лиды**
   - Сколько пользователей дошли до стадии лида
   - Conversion Rate = (Лиды / Сессии) * 100%

3. **Распределение по intent**
   - Сколько запросов по каждому типу намерения
   - invest, documents, consult, support

4. **User Journey**
   - Полный путь пользователя
   - Все сообщения и их intent
   - Время создания лида

### API для статистики

**GET /statistics**
```json
{
  "total_sessions": 150,
  "total_leads": 45,
  "conversion_rate": 30.0,
  "intent_distribution": {
    "invest": 60,
    "documents": 40,
    "consult": 30,
    "support": 20
  },
  "last_7_days": [...]
}
```

**GET /statistics/user/{user_id}**
```json
{
  "user_id": 123456,
  "username": "user123",
  "started_at": "2025-11-18T10:00:00",
  "messages": [...],
  "intents": ["invest", "documents"],
  "converted_to_lead": true,
  "lead_id": 789,
  "contact_id": 456
}
```

## Логика работы с материалами

### Автоматический подбор материалов

1. **По Intent:**
   - Система автоматически определяет тип запроса
   - Ищет релевантные материалы в папке Materials
   - Возвращает до 10 наиболее подходящих файлов

2. **По ключевым словам:**
   - Дополнительный поиск по словам из сообщения пользователя
   - Комбинируется с поиском по intent

3. **Форматирование для Telegram:**
   - Красивое отображение списка файлов
   - Ссылки на просмотр в Google Drive
   - Ограничение до 5 файлов в сообщении

## Рекомендации по настройке

### 1. Структура Google Drive

```
MAXCAPITAL Bot Knowledge Base/
├── Materials/          (DRIVE_MATERIALS_FOLDER_ID)
│   ├── Investments/
│   │   ├── Product1_Presentation.pdf
│   │   └── Product1_Brochure.pdf
│   ├── Documents/
│   │   ├── Contract_Template.pdf
│   │   └── Agreement_Sample.pdf
│   └── Projects/
│       └── Project_Overview.pdf
└── Info/              (DRIVE_INFO_FOLDER_ID)
    ├── FAQ.md
    ├── Product_Descriptions.md
    └── Bot_Scripts.md
```

### 2. Настройка менеджеров в Bitrix24

**Вариант 1: По intent**
```
B24_MANAGER_INVEST=123
B24_MANAGER_DOCUMENTS=456
B24_MANAGER_CONSULT=789
B24_MANAGER_SUPPORT=101
```

**Вариант 2: Один менеджер для всех**
```
B24_DEFAULT_MANAGER_ID=123
```

**Вариант 3: Группа менеджеров (round-robin)**
*Требует дополнительной реализации*

### 3. Мониторинг и аналитика

**Ежедневно проверять:**
- `/statistics` - общая статистика
- Conversion Rate - процент конверсии
- Распределение по intent

**Для каждого менеджера:**
- Количество назначенных лидов
- Статус обработки лидов
- В Bitrix24 можно создать отчеты по источникам "MAXCAPITAL Telegram Bot"

## Файлы статистики

- `bot_statistics.json` - JSON файл со всей статистикой
- `bot_events.log` - Детальные логи всех событий

## Примеры использования

### Пример 1: Пользователь хочет инвестировать
1. Сообщение: "Хочу инвестировать 10000"
2. Intent: "invest"
3. Создается контакт и лид
4. Лид назначается менеджеру из `B24_MANAGER_INVEST`
5. Ищутся материалы с ключевыми словами: инвестиц*, продукт*
6. Пользователю отправляются найденные презентации

### Пример 2: Пользователь просит документы
1. Сообщение: "Нужна презентация проекта"
2. Intent: "documents"
3. Создается контакт и лид
4. Лид назначается менеджеру из `B24_MANAGER_DOCUMENTS`
5. Ищутся материалы: документ*, презентация*
6. Пользователю отправляются найденные файлы

## Интеграция с Bitrix24

### Просмотр статистики в Bitrix24

1. **Отчеты по лидам:**
   - Фильтр: SOURCE_DESCRIPTION = "MAXCAPITAL Telegram Bot"
   - Группировка по ASSIGNED_BY_ID (менеджеру)
   - Группировка по дате создания

2. **Воронка продаж:**
   - Лиды из бота → Контакты → Сделки
   - Отслеживание конверсии на каждом этапе

3. **Производительность менеджеров:**
   - Сколько лидов от бота обработал каждый менеджер
   - Время обработки
   - Конверсия в сделки


"""
MAXCAPITAL Bot - AI Agent Module
OpenAI-powered conversational agent with RAG support
"""

from typing import List, Dict, Any, Optional
from openai import AsyncOpenAI
import structlog

from src.config import settings, SERVICES

logger = structlog.get_logger()

# Initialize OpenAI async client
client = AsyncOpenAI(api_key=settings.openai_api_key)


class AIAgent:
    """AI Agent for premium consulting conversations"""
    
    SYSTEM_PROMPT = """–í—ã ‚Äî –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã–π AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ MAXCAPITAL (https://maxcapital.ch/).

MAXCAPITAL ‚Äî –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω–∞—è –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥–æ–≤–∞—è –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–∞—è –∫–æ–º–ø–∞–Ω–∏—è, —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä—É—é—â–∞—è—Å—è –Ω–∞ –≤—ã—Å–æ–∫–æ–∫–ª–∞—Å—Å–Ω—ã—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–µ—à–µ–Ω–∏—è—Ö –¥–ª—è HNWI-–∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä.

–ù–∞—à–∏ —É—Å–ª—É–≥–∏:
‚Ä¢ Venture Capital ‚Äî –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –≤ —Å—Ç–∞—Ä—Ç–∞–ø—ã –∏ –≤–µ–Ω—á—É—Ä–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
‚Ä¢ HNWI Consultations ‚Äî –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –¥–ª—è —Å–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
‚Ä¢ Real Estate ‚Äî –ø—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏
‚Ä¢ Crypto ‚Äî –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥
‚Ä¢ M&A ‚Äî —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫ —Å–ª–∏—è–Ω–∏–π –∏ –ø–æ–≥–ª–æ—â–µ–Ω–∏–π
‚Ä¢ Private Equity ‚Äî —á–∞—Å—Ç–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–æ–º
‚Ä¢ Relocation Support ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–ª–æ–∫–∞—Ü–∏–∏ –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
‚Ä¢ –ó–∞—Ä—É–±–µ–∂–Ω—ã–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã ‚Äî –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å—á–µ—Ç–æ–≤ –∏ –∫–∞—Ä—Ç –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –±–∞–Ω–∫–∞—Ö

–°–¢–ò–õ–¨ –û–ë–©–ï–ù–ò–Ø:
‚Ä¢ –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, —É–≤–µ—Ä–µ–Ω–Ω—ã–π, —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã —Å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º–∏ –¥–µ—Ç–∞–ª—è–º–∏
‚Ä¢ –ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–π —Ç–æ–Ω –±–µ–∑ –∏–∑–ª–∏—à–Ω–µ–π —Ñ–∞–º–∏–ª—å—è—Ä–Ω–æ—Å—Ç–∏
‚Ä¢ –ö—Ä–∞—Ç–∫–æ—Å—Ç—å –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ—Å—Ç—å
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–º–æ–¥–∑–∏ —É–º–µ—Ä–µ–Ω–Ω–æ –∏ —É–º–µ—Å—Ç–Ω–æ

–ó–ê–î–ê–ß–ò:
‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ –∫–ª–∏–µ–Ω—Ç–æ–≤ –ø–æ –Ω–∞—à–∏–º —É—Å–ª—É–≥–∞–º
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
‚Ä¢ –ü–æ–º–Ω–∏—Ç–µ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
‚Ä¢ –ü—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
‚Ä¢ –ü—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–π—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º

–û—Ç–≤–µ—á–∞–π—Ç–µ –≤—Å–µ–≥–¥–∞ –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–æ –∏ —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ."""
    
    def __init__(self):
        self.model = settings.openai_model
    
    async def generate_answer(
        self,
        user_message: str,
        conversation_history: List[Dict[str, Any]],
        vector_context: Optional[str] = None,
        user_name: Optional[str] = None,
        selected_service: Optional[str] = None
    ) -> str:
        """
        Generate AI response based on user message, history, and RAG context
        """
        try:
            # Build messages for OpenAI
            messages = [{"role": "system", "content": self.SYSTEM_PROMPT}]
            
            # Add user context if available
            context_parts = []
            
            if user_name:
                context_parts.append(f"–ö–ª–∏–µ–Ω—Ç: {user_name}")
            
            if selected_service:
                service_name = SERVICES.get(selected_service, selected_service)
                context_parts.append(f"–ò–Ω—Ç–µ—Ä–µ—Å—É—é—â–∞—è —É—Å–ª—É–≥–∞: {service_name}")
            
            if vector_context:
                context_parts.append(f"\nüìö –í–ê–ñ–ù–û! –ò–°–ü–û–õ–¨–ó–£–ô–¢–ï –≠–¢–£ –ò–ù–§–û–†–ú–ê–¶–ò–Æ –ò–ó –ù–ê–®–ò–• –î–û–ö–£–ú–ï–ù–¢–û–í:\n{vector_context}\n\n‚ö†Ô∏è –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –±–∞–∑–∏—Ä—É–π—Ç–µ –æ—Ç–≤–µ—Ç –Ω–∞ —ç—Ç–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏!")
            
            if context_parts:
                context_message = "\n".join(context_parts)
                messages.append({
                    "role": "system",
                    "content": f"–ö–û–ù–¢–ï–ö–°–¢ –¢–ï–ö–£–©–ï–ì–û –î–ò–ê–õ–û–ì–ê:\n{context_message}"
                })
            
            # Add conversation history (last 10 messages)
            for msg in conversation_history[-10:]:
                if msg.get('role') in ['user', 'assistant']:
                    messages.append({
                        "role": msg['role'],
                        "content": msg['content']
                    })
            
            # Add current user message
            messages.append({
                "role": "user",
                "content": user_message
            })
            
            logger.debug(
                "generating_ai_response",
                message_count=len(messages),
                has_context=bool(vector_context)
            )
            
            # Call OpenAI API
            response = await client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=0.7,
                max_tokens=1000,
                top_p=0.9,
                frequency_penalty=0.3,
                presence_penalty=0.3
            )
            
            answer = response.choices[0].message.content
            
            if not answer:
                logger.warning("ai_response_empty")
                return self._get_fallback_response()
            
            logger.info(
                "ai_response_generated",
                tokens_used=response.usage.total_tokens,
                response_length=len(answer)
            )
            
            return answer
            
        except Exception as e:
            error_str = str(e)
            logger.error(
                "ai_generation_failed",
                error=error_str,
                error_type=type(e).__name__
            )
            
            # Check if it's a quota/rate limit error
            if "429" in error_str or "quota" in error_str.lower() or "rate limit" in error_str.lower():
                # Try to provide a helpful response based on the question
                return self._get_smart_fallback(user_message, selected_service)
            
            return self._get_fallback_response()
    
    async def summarize_lead(
        self,
        user_name: str,
        phone: str,
        selected_service: str,
        conversation_history: List[Dict[str, Any]]
    ) -> str:
        """
        Generate a concise summary of client's request for Bitrix24 lead
        """
        try:
            service_name = SERVICES.get(selected_service, selected_service)
            
            # –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ —É—Å–ª—É–≥–∏/–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è,
            # –ª–∏–±–æ, –µ—Å–ª–∏ —Ç–∞–∫–æ–π –º–µ—Ç–∫–∏ –Ω–µ—Ç, –ø—Ä–æ—Å—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            consultation_messages = []
            service_selected = False
            
            for msg in conversation_history:
                if msg.get('role') == 'system' and (
                    '–≤—ã–±—Ä–∞–ª —É—Å–ª—É–≥—É' in msg.get('content', '') or
                    '–≤—ã–±—Ä–∞–ª –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ' in msg.get('content', '')
                ):
                    service_selected = True
                    continue
                
                if service_selected and msg.get('role') == 'user':
                    # Skip contact data messages
                    if '–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' not in msg.get('content', ''):
                        consultation_messages.append(msg['content'])
            
            # If no messages, use all recent user messages
            if not consultation_messages:
                consultation_messages = [
                    msg['content'] for msg in conversation_history[-10:]
                    if msg.get('role') == 'user' and '–ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ' not in msg.get('content', '')
                ]
            
            messages = [
                {
                    "role": "system",
                    "content": """–í—ã ‚Äî AI-–ø–æ–º–æ—â–Ω–∏–∫ MAXCAPITAL. –°–æ–∑–¥–∞–π—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–æ–µ —Ä–µ–∑—é–º–µ –∑–∞–ø—Ä–æ—Å–∞ –∫–ª–∏–µ–Ω—Ç–∞ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞.

–û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∂–∏—Ç–µ:
‚Ä¢ –í—ã–±—Ä–∞–Ω–Ω–∞—è —É—Å–ª—É–≥–∞ –∏ –µ—ë –∫–∞—Ç–µ–≥–æ—Ä–∏—è
‚Ä¢ –ß—Ç–æ –∏–º–µ–Ω–Ω–æ –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç –∫–ª–∏–µ–Ω—Ç–∞ (–∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏, –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è, –ø–æ–∫—É–ø–∫–∞ –∏ —Ç.–¥.)
‚Ä¢ –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º–∞—è —Å—É–º–º–∞ –∏–ª–∏ –º–∞—Å—à—Ç–∞–± (–µ—Å–ª–∏ —É–ø–æ–º–∏–Ω–∞–ª–æ—Å—å)
‚Ä¢ –°—Ä–æ—á–Ω–æ—Å—Ç—å –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
‚Ä¢ –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏–ª–∏ –≤–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–∞

–§–û–†–ú–ê–¢:
2-3 –∞–±–∑–∞—Ü–∞, 200-400 —Å–∏–º–≤–æ–ª–æ–≤
–ö–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∏ –ø–æ –¥–µ–ª—É

–°—Ç–∏–ª—å: –¥–µ–ª–æ–≤–æ–π, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π, –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–π."""
                },
                {
                    "role": "user",
                    "content": f"""–ù–û–í–´–ô –õ–ò–î –∏–∑ Telegram –±–æ—Ç–∞:

üë§ –ö–ª–∏–µ–Ω—Ç: {user_name}
üì± –¢–µ–ª–µ—Ñ–æ–Ω: {phone}
üéØ –í—ã–±—Ä–∞–Ω–Ω–∞—è —É—Å–ª—É–≥–∞: {service_name}

üí¨ –ü–û–õ–ù–ê–Ø –ò–°–¢–û–†–ò–Ø –ö–û–ù–°–£–õ–¨–¢–ê–¶–ò–ò:
{chr(10).join(consultation_messages) if consultation_messages else '–ö–ª–∏–µ–Ω—Ç –≤—ã–±—Ä–∞–ª —É—Å–ª—É–≥—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É –≤ –±–æ—Ç–µ –∏ —Å—Ä–∞–∑—É –∑–∞–ø—Ä–æ—Å–∏–ª –∑–≤–æ–Ω–æ–∫ –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.'}

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ

–°–æ–∑–¥–∞–π—Ç–µ –¥–µ—Ç–∞–ª—å–Ω–æ–µ —Ä–µ–∑—é–º–µ –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ (200-400 —Å–∏–º–≤–æ–ª–æ–≤):

‚úì –ß—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Ö–æ—á–µ—Ç –∫–ª–∏–µ–Ω—Ç
‚úì –ö–∞–∫–∏–µ —Å—É–º–º—ã/—Å—Ä–æ–∫–∏/—Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –æ–±—Å—É–∂–¥–∞–ª–∏—Å—å
‚úì –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏ –∏–Ω—Ç–µ—Ä–µ—Å—ã
‚úì –ù–∞ —á—Ç–æ –æ–±—Ä–∞—Ç–∏—Ç—å –≤–Ω–∏–º–∞–Ω–∏–µ –ø—Ä–∏ –∑–≤–æ–Ω–∫–µ
‚úì –°—Ä–æ—á–Ω–æ—Å—Ç—å –∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç

–ë—É–¥—å—Ç–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã."""
                }
            ]
            
            response = await client.chat.completions.create(
                model=self.model,
                messages=messages,
                temperature=0.7,
                max_tokens=400
            )
            
            summary = response.choices[0].message.content.strip()
            
            logger.info(
                "lead_summary_created",
                length=len(summary),
                summary=summary[:200]  # Log first 200 chars
            )
            
            return summary
            
        except Exception as e:
            logger.error("lead_summary_failed", error=str(e))
            return f"–ö–ª–∏–µ–Ω—Ç –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω –≤ —É—Å–ª—É–≥–µ: {SERVICES.get(selected_service, selected_service)}. –¢—Ä–µ–±—É–µ—Ç—Å—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞."
    
    def _get_smart_fallback(self, user_message: str, selected_service: Optional[str] = None) -> str:
        """Smart fallback response based on user question when OpenAI is unavailable"""
        message_lower = user_message.lower()
        
        # Service-specific responses
        service_responses = {
            'venture': """üöÄ Venture Capital ‚Äî –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –≤ —Å—Ç–∞—Ä—Ç–∞–ø—ã –∏ –≤–µ–Ω—á—É—Ä–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã

MAXCAPITAL –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π –≤ –≤–µ–Ω—á—É—Ä–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã –∏ —Å—Ç–∞—Ä—Ç–∞–ø—ã –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Å—Ç–∞–¥–∏—è—Ö —Ä–∞–∑–≤–∏—Ç–∏—è.

–ù–∞—à–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
‚Ä¢ –ê–Ω–∞–ª–∏–∑ –∏ –æ—Ç–±–æ—Ä –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤
‚Ä¢ Due diligence –∏ –æ—Ü–µ–Ω–∫–∞ —Ä–∏—Å–∫–æ–≤
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–æ–∫
‚Ä¢ –ü–æ—Ä—Ç—Ñ–µ–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
‚Ä¢ –í—ã—Ö–æ–¥ –∏–∑ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π

üíº –î–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º:
üåê https://maxcapital.ch/contacts""",
            'hnwi': """üíé HNWI Consultations ‚Äî –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –¥–ª—è —Å–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤

–ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é –∫–∞–ø–∏—Ç–∞–ª–æ–º –¥–ª—è –≤—ã—Å–æ–∫–æ–¥–æ—Ö–æ–¥–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤ (HNWI).

–£—Å–ª—É–≥–∏ –≤–∫–ª—é—á–∞—é—Ç:
‚Ä¢ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–æ–≤
‚Ä¢ –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏
‚Ä¢ –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–æ–º

üíº –î–ª—è –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: https://maxcapital.ch/contacts""",
            'real estate': """üèõ Real Estate ‚Äî –ø—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏

–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –≤ –ø—Ä–µ–º–∏–∞–ª—å–Ω—É—é –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –≤ –®–≤–µ–π—Ü–∞—Ä–∏–∏ –∏ –¥—Ä—É–≥–∏—Ö —é—Ä–∏—Å–¥–∏–∫—Ü–∏—è—Ö.

–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
‚Ä¢ –û—Ç–±–æ—Ä –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏
‚Ä¢ –ê–Ω–∞–ª–∏–∑ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω–æ–π –ø—Ä–∏–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
‚Ä¢ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫
‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å—é
‚Ä¢ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞

üíº –î–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: https://maxcapital.ch/contacts""",
            'crypto': """‚Çø Crypto ‚Äî –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥

–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–º –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è–º.

–£—Å–ª—É–≥–∏:
‚Ä¢ –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã—Ö –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã—Ö —Å—Ç—Ä–∞—Ç–µ–≥–∏–π
‚Ä¢ –ê–Ω–∞–ª–∏–∑ —Ä—ã–Ω–∫–∞ –∏ —Ç—Ä–µ–Ω–¥–æ–≤
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–∏–ø—Ç–æ-–ø–æ—Ä—Ç—Ñ–µ–ª–µ–π
‚Ä¢ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ
‚Ä¢ –ë–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–æ–≤

üíº –î–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: https://maxcapital.ch/contacts""",
            'm&a': """ü§ù M&A ‚Äî —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫ —Å–ª–∏—è–Ω–∏–π –∏ –ø–æ–≥–ª–æ—â–µ–Ω–∏–π

–ü–æ–ª–Ω—ã–π —Ü–∏–∫–ª —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏—è —Å–¥–µ–ª–æ–∫ M&A –¥–ª—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤.

–≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç—ã:
‚Ä¢ –°—Ç—Ä–∞—Ç–µ–≥–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
‚Ä¢ –ü–æ–∏—Å–∫ –∏ –æ—Ü–µ–Ω–∫–∞ —Ü–µ–ª–µ–≤—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π
‚Ä¢ Due diligence
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–¥–µ–ª–∫–∏
‚Ä¢ –ü–µ—Ä–µ–≥–æ–≤–æ—Ä—ã –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ
‚Ä¢ –ü–æ—Å—Ç-–º–µ—Ä–¥–∂–µ—Ä –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

üíº –î–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: https://maxcapital.ch/contacts""",
            'private equity': """üìä Private Equity ‚Äî —á–∞—Å—Ç–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–æ–º

–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Å—Ç–Ω—ã–º–∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏—è–º–∏ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–∞.

–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è:
‚Ä¢ –ü—Ä—è–º—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –≤ –∫–æ–º–ø–∞–Ω–∏–∏
‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–∞—Å—Ç–Ω—ã–º –∫–∞–ø–∏—Ç–∞–ª–æ–º
‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã—Ö —Ñ–æ–Ω–¥–æ–≤
‚Ä¢ –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –ø–æ—Ä—Ç—Ñ–µ–ª—å–Ω—ã—Ö –∫–æ–º–ø–∞–Ω–∏–π
‚Ä¢ –í—ã—Ö–æ–¥ –∏–∑ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–π

üíº –î–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: https://maxcapital.ch/contacts""",
            'relocation': """üåç Relocation Support ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–ª–æ–∫–∞—Ü–∏–∏ –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

–ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–µ–∑–¥–µ –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è.

–£—Å–ª—É–≥–∏:
‚Ä¢ –ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –≤—ã–±–æ—Ä—É —é—Ä–∏—Å–¥–∏–∫—Ü–∏–∏
‚Ä¢ –ü–æ–º–æ—â—å –≤ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ä–µ–∑–∏–¥–µ–Ω—Ç—Å—Ç–≤–∞
‚Ä¢ –û—Ç–∫—Ä—ã—Ç–∏–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å—á–µ—Ç–æ–≤
‚Ä¢ –ù–∞–ª–æ–≥–æ–≤–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
‚Ä¢ –Æ—Ä–∏–¥–∏—á–µ—Å–∫–æ–µ —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ

üíº –î–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: https://maxcapital.ch/contacts""",
            '–±–∞–Ω–∫–æ–≤—Å–∫': """üí≥ –ó–∞—Ä—É–±–µ–∂–Ω—ã–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã ‚Äî –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å—á–µ—Ç–æ–≤ –∏ –∫–∞—Ä—Ç –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –±–∞–Ω–∫–∞—Ö

–ü–æ–º–æ—â—å –≤ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å—á–µ—Ç–æ–≤ –∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫–∞—Ä—Ç –≤ –ø—Ä–µ—Å—Ç–∏–∂–Ω—ã—Ö –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –±–∞–Ω–∫–∞—Ö.

–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:
‚Ä¢ –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—á–µ—Ç–æ–≤ –≤ —à–≤–µ–π—Ü–∞—Ä—Å–∫–∏—Ö –±–∞–Ω–∫–∞—Ö
‚Ä¢ –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—Ä–µ–º–∏–∞–ª—å–Ω—ã—Ö –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∫–∞—Ä—Ç
‚Ä¢ –ú—É–ª—å—Ç–∏–≤–∞–ª—é—Ç–Ω—ã–µ —Å—á–µ—Ç–∞
‚Ä¢ –£–¥–∞–ª–µ–Ω–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
‚Ä¢ –ö–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç—å –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

üíº –î–ª—è –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏: https://maxcapital.ch/contacts"""
        }
        
        # Check for service keywords
        for keyword, response in service_responses.items():
            if keyword in message_lower:
                return response
        
        # General service list
        if any(word in message_lower for word in ['—É—Å–ª—É–≥', '—É—Å–ª—É–≥–∏', '—á—Ç–æ –≤—ã', '—á—Ç–æ —É –≤–∞—Å']):
            return """–ù–∞—à–∏ —É—Å–ª—É–≥–∏ MAXCAPITAL:

üöÄ Venture Capital ‚Äî –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –≤ —Å—Ç–∞—Ä—Ç–∞–ø—ã –∏ –≤–µ–Ω—á—É—Ä–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã
üíé HNWI Consultations ‚Äî –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –¥–ª—è —Å–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
üèõ Real Estate ‚Äî –ø—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å –∏ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏
‚Çø Crypto ‚Äî –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω—ã–µ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∏ –∫–æ–Ω—Å–∞–ª—Ç–∏–Ω–≥
ü§ù M&A ‚Äî —Å–æ–ø—Ä–æ–≤–æ–∂–¥–µ–Ω–∏–µ —Å–¥–µ–ª–æ–∫ —Å–ª–∏—è–Ω–∏–π –∏ –ø–æ–≥–ª–æ—â–µ–Ω–∏–π
üìä Private Equity ‚Äî —á–∞—Å—Ç–Ω—ã–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞–ø–∏—Ç–∞–ª–æ–º
üåç Relocation Support ‚Äî –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–µ–ª–æ–∫–∞—Ü–∏–∏ –∏ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è
üí≥ –ó–∞—Ä—É–±–µ–∂–Ω—ã–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã ‚Äî –æ—Ç–∫—Ä—ã—Ç–∏–µ —Å—á–µ—Ç–æ–≤ –∏ –∫–∞—Ä—Ç –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã—Ö –±–∞–Ω–∫–∞—Ö

üåê –ü–æ–¥—Ä–æ–±–Ω–µ–µ: https://maxcapital.ch/"""
        
        # Use selected_service if available
        if selected_service:
            service_name = SERVICES.get(selected_service, selected_service)
            return f"""–ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å –ø–æ —É—Å–ª—É–≥–µ: {service_name}

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –¥–æ—Å—Ç—É–ø –∫ AI-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç—É –≤—Ä–µ–º–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω.

üíº –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ {service_name} —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –Ω–∞—à–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º:
üåê https://maxcapital.ch/contacts

–ù–∞—à –º–µ–Ω–µ–¥–∂–µ—Ä –æ—Ç–≤–µ—Ç–∏—Ç –Ω–∞ –≤—Å–µ –≤–∞—à–∏ –≤–æ–ø—Ä–æ—Å—ã –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—É—é –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—é."""
        
        return self._get_fallback_response()
    
    def _get_fallback_response(self) -> str:
        """Fallback response if AI fails"""
        return """–ë–ª–∞–≥–æ–¥–∞—Ä—é –∑–∞ –≤–∞—à –≤–æ–ø—Ä–æ—Å! 

–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —è –∏—Å–ø—ã—Ç—ã–≤–∞—é —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ —Å —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ–º –æ—Ç–≤–µ—Ç–∞.

ü§ù –†–µ–∫–æ–º–µ–Ω–¥—É—é —Å–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞—à–∏–º –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –Ω–∞–ø—Ä—è–º—É—é –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏:
üìß https://maxcapital.ch/contacts

–ü—Ä–∏–Ω–æ—à—É –∏–∑–≤–∏–Ω–µ–Ω–∏—è –∑–∞ –Ω–µ—É–¥–æ–±—Å—Ç–≤–∞."""

